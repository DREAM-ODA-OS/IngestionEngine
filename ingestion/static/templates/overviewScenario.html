{% extends "base.html" %}
{% load staticfiles %}
{% load dajaxice_templatetags %}

{% block head %}

    {% if jqueryui_offlineurl %}
      <link rel="stylesheet"
      href="{{jqueryui_offlineurl}}css/smoothness/jquery-ui.css" />
    {% else %}
      <link rel="stylesheet"
      href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
    {% endif %}

{% dajaxice_js_import 'nocsrf' %}

<script>
    // !!! do not import another jquery to support jquery-ui !!!

    // globals
    jscenarios = []; // global array of scenarios
    first_time = 1; // global parameter

    //  the globals operation_pending and was_active is used to determine if
    //  sync_scenarios should be called periodically
    operation_pending = false;
    was_active = false;


    $(document).ready(function() {

        if (first_time==1) {
             sync_scenarios();
        }

        window.setInterval(
            function(){
                var active = false
                for (var i=0; i<jscenarios.length; i++) {
                    // Continuous updates while done is not zero.
                    if (jscenarios[i].st_done > 0) {
                        active = true;
                        was_active = true;
                    }
                }
                if (active || operation_pending) {
                    sync_scenarios();
                }
                // Reset pending flag when activity stops
                if (!active && was_active) {
                        operation_pending = false;
                        was_active = false;
                }
            },
            1250); // every so often, in milliceconds
        });


    function run_delete(id_scenario) {
        // update status of scenario
        sync_scenarios();
        for (var i=0; i<jscenarios.length; i++) {
            if (id_scenario==jscenarios[i].id && jscenarios[i].st_isav!=0) {
                if(confirm('Delete scenario - ' + id_scenario + '?')) {
                    // send ajax request to Work-Flow-Manager to delete scenario
                    Dajaxice.ingestion.delete_scenario_wfm(function(data){},
						       {'scenario_id':id_scenario});
                }
            }
        }
    }

    function run_ingestion(id_scenario){
        // update status of scenario
        sync_scenarios();
        for (var i=0; i<jscenarios.length; i++) {
            if (id_scenario==jscenarios[i].id && jscenarios[i].st_isav!=0) {
                if(confirm('Ingest scenario ' + jscenarios[i].ncn_id+'?')) {
                    // send ajax request to Work-Flow-Manager to ingest scenario
                    Dajaxice.ingestion.ingest_scenario_wfm(
                        function(data){
                            if(data.status !== undefined) {
                                if (data.status != 0) {
                                    alert(data.message);
                                }
                            }
                        },
                        {"scenario_id":id_scenario});
                    // ensure updates of the page via sychronize_scenario
                    operation_pending = true;
                    sync_scenarios();
                }
            } else {
                alert('Scenario '+jscenarios[i].ncn_id+
                      'is locked - operation in progress');
            }
        }
    }

    function stop_ingestion(s)
    {
        alert("stopping ingestion, scnenario:"+s);
        Dajaxice.ingestion.stop_ingestion_wfm(
            function(data){
                if(data.status !== undefined) {
                    if (data.status != 0) {
                        alert(data.message)
                            }
                }
            },
            {"scenario_id":s});
        Dajaxice.ingestion.synchronize_scenarios(update_scenario);
    }

    function goToLocation(s)
    {
        var new_page = "http://".concat(window.location.host,"/",s);
        window.location.replace(new_page)
    }


    function create_scenario(data) {
        //     0         1          2        3            4          5      6
        //scenario_id,ncn_id,status_id,status_is_available,status_status,status_done
        // create scenario as javascript object
        var scenario = new Object();
        scenario.id     = data[0];
        scenario.ncn_id = data[1];

        if (data[2]>0) { // 1 means automatic, 2 means manual
            scenario.auto_ingest = 1;
        }else {
            scenario.auto_ingest = 0;
        }

        scenario.st_id   = data[3];
        scenario.st_isav = data[4];
        scenario.st_st   = data[5];
        scenario.st_done = data[6];
        console.log(scenario);
        return scenario;
    }

    function add_scenario(scenario) {
        jscenarios.push(scenario);
    }

    function remove_scenario(scenario) {
        var i = jscenarios.indexOf(scenario)
        splice (i,i);
    }

    function update_scenario(data) { // called by dajaxice every N-milliseconds
        if (data === null)
        {
            alert("update_scenario: data is null");
            return;
        }

        var ajax_data = data.jscenario_status;
        for (var i=0; i<ajax_data.length; i++) {
            var obj = create_scenario(ajax_data[i]);
            if (first_time==1){
                jscenarios.push(obj);
            }else {
                jscenarios[i] = obj;
            }
        }
        if (first_time==1){
            first_time = 0;
        }
        // update widgets (buttons,progress bars, ...)
        update_webpage();

        //
        for (var i=0; i<jscenarios.length; i++) {
            if (jscenarios[i].st_st=="DELETED") {
                Dajaxice.ingestion.delete_scenario_django(
                    function(data){alert(data.message);},
                    {'scenario_id':jscenarios[i].id});
            }
        }
    }

    function update_webpage() {
        // update widgets of Web page
        for (var i=0; i<jscenarios.length; i++) {
                       
            // hide div_scenario of deleted scenario
            if (jscenarios[i].st_st=="DELETED") {
                current_id = "#div_scenario_" + jscenarios[i].id;
                $(current_id).hide()
            }

            // update tr_status
            current_id = "div_status_" + jscenarios[i].id;
            var element = document.getElementById(current_id);
            element.innerHTML = " " + jscenarios[i].st_st;

            // update progress bar
            done = jscenarios[i].st_done;
            el = document.getElementById("progress_bar_"+jscenarios[i].id);
            el.style.width = done.toString() + "%";
            // if use jqueryui, instead of the above do this:
            //    current_id = "#div_progress_bar_" + jscenarios[i].id;
            //    $(current_id).progressbar({ value: done });

            //  enable/disable buttons
            buttons = [
               "ingest_scenario_button",
               //               "manage_data_button",
               //               "load_register_button",
               "edit_scenario_button",
               "delete_scenario_button"
               ];
            for (var j=0; j<buttons.length; j++) {
                //current_id = "#" + buttons[j] + "_" + jscenarios[i].id;
                current_id = buttons[j] + "_" + jscenarios[i].id;
                if (jscenarios[i].st_isav==0) { // disable
                    document.getElementById(current_id).disabled = true;
                }else { // enable
                    document.getElementById(current_id).disabled = false;
                }

                if (buttons[j]=="ingest_button") {
                    if (jscenarios[i].auto_ingest==1) {
                        document.getElementById(current_id).disabled = true;
                    }
                }
            }
            // can be extended
        }
    }

    function sync_scenarios() {
       Dajaxice.ingestion.synchronize_scenarios(update_scenario);
    }

    function localtest1(){}

</script>
    

<style>
    .button
    {
        width: 3cm; 
        height: 0.74cm; 
        font-family: 'Arial', sans-serif; 
        font-size: 12pt;
    }
</style>

{% endblock %}

{% block title %}
<P class="ieTitle3">Scenario Overview</P>
{% endblock %}
{% block content %}

<!-- for debugging>
<INPUT TYPE=BUTTON class="button" name="Button" VALUE="TEST1" title="for debugging"
  onClick="localtest1()" -->
<!--  onClick="Dajaxice.ingestion.test1(update_scenario)" -->
<!--        onClick="Dajaxice.ingestion.synchronize_scenarios(update_scenario)" -->
<!-- INPUT TYPE=BUTTON class="button" name="Button" VALUE="TEST2"
       onClick="update_webpage()" -->

<p>
<INPUT TYPE=BUTTON class="button"
    name="AddScenarioButton"
    VALUE="Add Scenario"
    onclick="goToLocation('scenario/add/')">
<br>
</p>


{% for scenario in scenarios %}
<div id="div_scenario_{{scenario.id}}">
<TABLE WIDTH=100% CELLPADDING=0 CELLSPACING=0 >
    <TR BGCOLOR="#bbd5a9">
      <TD WIDTH=24px ></TD>
      <TD WIDTH=19% >
             <INPUT TYPE="BUTTON" class="IngestButton"
               id="ingest_scenario_button_{{scenario.id}}"
               name="IngestButton" title="Ingest"
               onClick="run_ingestion({{scenario.id}})"/>
             <INPUT TYPE="BUTTON" class="EditButton"
              id="edit_scenario_button_{{scenario.id}}"
              name="EditScenarioButton" title="Edit ..."
              onClick="goToLocation('scenario/edit/{{scenario.id}}')"/>
             <INPUT TYPE="BUTTON" class="DeleteButton"
              id="delete_scenario_button_{{scenario.id}}"
              title="Delete"
              onClick="run_delete({{scenario.id}})"
              />
      </TD>
      <TD WIDTH=10% class="ieScTblHdrCell" title="Unique Id">{{scenario.ncn_id}}</TD>
      <TD colspan = 2 class="ieScTblHdrCell" title="Name">{{scenario.scenario_name}}</TD>
    </TR>
    <TR BGCOLOR="#ddefcb">
       <TD ></TD>
       <TD colspan=4 class="ieDescCell" title="Description">{{scenario.scenario_description}}</TD>
    </TR>
    <TR >
      <TD ></TD>
      <TD>  <div id="div_status_{{scenario.id}}">  </div> </TD>
      <TD>
        <INPUT title="Stop" class="StopButton"
        id="stop_button_{{scenario.id}}"
        OnClick="stop_ingestion({{scenario.id}})">
      </TD>
      <TD> <div id="pro_container__{{scenario.id}}"
                    style="width:100%; height:10px; border:1px solid black; vertical-align:middle; padding:0" >
               <div id="progress_bar_{{scenario.id}}" 
                    style="width:20%; height:10px; border:none; background-color:#6666dd; vertical-align:sub; padding:0" >
               </div>
               </div>
      </TD>
    </TR>
</TABLE>

</div>
{% endfor %}

<p>
<br>
<INPUT TYPE=BUTTON class="button"
    name="AddScenarioButton"
    VALUE="Add Scenario"
    onclick="goToLocation('scenario/add/')">
</p>

{% endblock %}
